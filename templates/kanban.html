<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STEP 2: Î∂ÑÎ•ò - Ïπ∏Î∞ò Î≥¥Îìú</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .header h1 { font-size: 1.1rem; font-weight: 500; }
        
        .header-buttons { display: flex; gap: 8px; }
        
        .header button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.85rem;
        }
        
        .header button:hover { background: rgba(255,255,255,0.3); }
        .header button.primary { background: #28a745; }
        
        .main-container {
            display: flex;
            gap: 16px;
            height: calc(100vh - 100px);
        }
        
        .board-container {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            flex: 1;
            padding-bottom: 10px;
            align-items: flex-start;
        }
        
        .column {
            background: #f4f5f7;
            border-radius: 10px;
            min-width: 240px;
            max-width: 240px;
            display: flex;
            flex-direction: column;
            max-height: 100%;
        }
        
        .column-header {
            padding: 10px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
        }
        
        .column-header input {
            background: transparent;
            border: none;
            font-size: 0.9rem;
            font-weight: 600;
            color: #333;
            width: 80%;
        }
        
        .column-header input:focus { 
            outline: none; 
            background: white; 
            border-radius: 4px; 
            padding: 4px 6px;
            margin: -4px -6px;
        }
        
        .column-header input::placeholder { color: #999; }
        
        .column-count {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            min-width: 20px;
            text-align: center;
        }
        
        .column-body {
            padding: 8px;
            flex: 1;
            overflow-y: auto;
            min-height: 80px;
        }
        
        .column-body.drag-over { background: #e3e6ff; }
        
        .column-footer {
            padding: 8px;
            border-top: 1px solid #eee;
        }
        
        .add-card-btn {
            width: 100%;
            padding: 6px;
            background: transparent;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 0.8rem;
            text-align: left;
        }
        
        .add-card-btn:hover { color: #667eea; }
        
        .card {
            background: white;
            border-radius: 6px;
            padding: 8px 10px;
            margin-bottom: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            cursor: grab;
            font-size: 0.85rem;
            line-height: 1.4;
            word-break: keep-all;
        }
        
        .card:hover { box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
        .card.dragging { opacity: 0.5; }
        
        .add-column {
            background: rgba(255,255,255,0.08);
            border: 2px dashed rgba(255,255,255,0.25);
            border-radius: 10px;
            min-width: 240px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            color: rgba(255,255,255,0.5);
            font-size: 0.9rem;
            padding: 30px 20px;
            transition: all 0.2s;
        }
        
        .add-column:hover {
            background: rgba(255,255,255,0.15);
            color: white;
            border-color: rgba(255,255,255,0.4);
        }
        
        .unassigned { background: #fff8e1; }
        .unassigned .column-header { background: #ffecb3; }
        
        /* Ï±ÑÌåÖ ÏÇ¨Ïù¥ÎìúÎ∞î */
        .chat-sidebar {
            width: 320px;
            min-width: 320px;
            background: white;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        
        .chat-sidebar.hidden {
            width: 0;
            min-width: 0;
            opacity: 0;
            overflow: hidden;
        }
        
        .chat-header {
            padding: 12px 14px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 10px 10px 0 0;
        }
        
        .chat-header h3 { font-size: 0.95rem; }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            font-size: 0.85rem;
        }
        
        .chat-input {
            padding: 10px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 6px;
        }
        
        .chat-input input {
            flex: 1;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.85rem;
        }
        
        .chat-input button {
            padding: 8px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .message {
            margin-bottom: 8px;
            padding: 8px 10px;
            border-radius: 8px;
            max-width: 90%;
            line-height: 1.4;
        }
        
        .message.user {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-left: auto;
        }
        
        .message.assistant {
            background: white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .chat-toggle-btn {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: none;
        }
        
        .chat-sidebar.hidden + .chat-toggle-btn { display: flex; justify-content: center; align-items: center; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîÄ STEP 2: Î∂ÑÎ•ò - Ìè¨Ïä§Ìä∏ÏûáÏùÑ Ïó¥Ïóê ÎìúÎûòÍ∑∏Ìï¥ÏÑú Î∂ÑÎ•òÌïòÏÑ∏Ïöî</h1>
        <div class="header-buttons">
            <button onclick="goBackToStep1()">‚Üê STEP 1</button>
            <button onclick="toggleChat()">üí¨</button>
            <button onclick="saveAndContinue()" class="primary">Ï†ÄÏû• & STEP 3 ‚Üí</button>
        </div>
    </div>
    
    <div class="main-container">
        <div class="board-container" id="boardContainer">
            <!-- ÎØ∏Î∂ÑÎ•ò Ïó¥ -->
            <div class="column unassigned" id="unassigned">
                <div class="column-header">
                    <span style="font-weight:600;">üìã ÎØ∏Î∂ÑÎ•ò</span>
                    <span class="column-count">0</span>
                </div>
                <div class="column-body" data-column="unassigned"></div>
                <div class="column-footer">
                    <button class="add-card-btn" onclick="addCard('unassigned')">+ Ìï≠Î™© Ï∂îÍ∞Ä</button>
                </div>
            </div>
            
            <!-- Îπà Ïó¥ 3Í∞ú -->
            <div class="column" id="col-1">
                <div class="column-header">
                    <input type="text" placeholder="Ïó¥ Ïù¥Î¶Ñ..." onchange="saveState()">
                    <span class="column-count">0</span>
                </div>
                <div class="column-body" data-column="col-1"></div>
                <div class="column-footer">
                    <button class="add-card-btn" onclick="addCard('col-1')">+ Ìï≠Î™© Ï∂îÍ∞Ä</button>
                </div>
            </div>
            
            <div class="column" id="col-2">
                <div class="column-header">
                    <input type="text" placeholder="Ïó¥ Ïù¥Î¶Ñ..." onchange="saveState()">
                    <span class="column-count">0</span>
                </div>
                <div class="column-body" data-column="col-2"></div>
                <div class="column-footer">
                    <button class="add-card-btn" onclick="addCard('col-2')">+ Ìï≠Î™© Ï∂îÍ∞Ä</button>
                </div>
            </div>
            
            <div class="column" id="col-3">
                <div class="column-header">
                    <input type="text" placeholder="Ïó¥ Ïù¥Î¶Ñ..." onchange="saveState()">
                    <span class="column-count">0</span>
                </div>
                <div class="column-body" data-column="col-3"></div>
                <div class="column-footer">
                    <button class="add-card-btn" onclick="addCard('col-3')">+ Ìï≠Î™© Ï∂îÍ∞Ä</button>
                </div>
            </div>
            
            <!-- Ïó¥ Ï∂îÍ∞Ä Î≤ÑÌäº -->
            <div class="add-column" onclick="addColumn()">+ Ïó¥ Ï∂îÍ∞Ä</div>
        </div>
        
        <!-- Ï±ÑÌåÖ ÏÇ¨Ïù¥ÎìúÎ∞î -->
        <div class="chat-sidebar" id="chatSidebar">
            <div class="chat-header">
                <h3>üèõÔ∏è ÏÜåÌÅ¨ÎùºÌÖåÏä§</h3>
                <button onclick="toggleChat()" style="background:none;border:none;color:white;font-size:16px;cursor:pointer;">‚úï</button>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input">
                <input type="text" id="chatInput" placeholder="ÏßàÎ¨∏..." onkeydown="if(event.key==='Enter')sendChat()">
                <button onclick="sendChat()">Ï†ÑÏÜ°</button>
            </div>
        </div>
        <button class="chat-toggle-btn" onclick="toggleChat()">üí¨</button>
    </div>
    
    <script>
        let cardIdCounter = 0;
        let columnIdCounter = 4;
        
        // ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ ÏÑ§Ï†ï
        function setupDragDrop() {
            document.querySelectorAll('.column-body').forEach(body => {
                body.ondragover = (e) => { e.preventDefault(); };
                body.ondragenter = (e) => { e.target.classList.add('drag-over'); };
                body.ondragleave = (e) => { 
                    if (e.target.classList.contains('column-body')) {
                        e.target.classList.remove('drag-over'); 
                    }
                };
                body.ondrop = drop;
            });
        }
        
        function createCard(text, id = null) {
            const card = document.createElement('div');
            card.className = 'card';
            card.draggable = true;
            card.id = id || `card-${cardIdCounter++}`;
            card.textContent = text;
            card.ondragstart = (e) => {
                e.target.classList.add('dragging');
                e.dataTransfer.setData('text/plain', e.target.id);
            };
            card.ondragend = (e) => e.target.classList.remove('dragging');
            return card;
        }
        
        function drop(e) {
            e.preventDefault();
            let target = e.target;
            if (!target.classList.contains('column-body')) {
                target = target.closest('.column-body');
            }
            if (target) {
                target.classList.remove('drag-over');
                const cardId = e.dataTransfer.getData('text/plain');
                const card = document.getElementById(cardId);
                if (card) {
                    const itemText = card.textContent;
                    const col = target.closest('.column');
                    const colName = col.querySelector('input')?.value || 'ÎØ∏Î∂ÑÎ•ò';
                    
                    target.appendChild(card);
                    updateCounts();
                    saveState();
                    
                    if (!col.classList.contains('unassigned') && colName) {
                        askSocrates(`"${itemText}"ÏùÑ "${colName || 'ÏÉà Ïó¥'}"Ïóê ÎÑ£ÏóàÏñ¥.`);
                    }
                }
            }
        }
        
        function addCard(columnId) {
            const text = prompt('ÏÉà Ìï≠Î™©:');
            if (!text) return;
            
            const col = document.getElementById(columnId);
            const body = col.querySelector('.column-body');
            body.appendChild(createCard(text));
            updateCounts();
            saveState();
        }
        
        function addColumn() {
            const colId = `col-${columnIdCounter++}`;
            const column = document.createElement('div');
            column.className = 'column';
            column.id = colId;
            column.innerHTML = `
                <div class="column-header">
                    <input type="text" placeholder="Ïó¥ Ïù¥Î¶Ñ..." onchange="saveState()">
                    <span class="column-count">0</span>
                </div>
                <div class="column-body" data-column="${colId}"></div>
                <div class="column-footer">
                    <button class="add-card-btn" onclick="addCard('${colId}')">+ Ìï≠Î™© Ï∂îÍ∞Ä</button>
                </div>
            `;
            
            document.querySelector('.add-column').before(column);
            setupDragDrop();
            saveState();
        }
        
        function updateCounts() {
            document.querySelectorAll('.column').forEach(col => {
                const count = col.querySelector('.column-body').children.length;
                col.querySelector('.column-count').textContent = count;
            });
        }
        
        function toggleChat() {
            document.getElementById('chatSidebar').classList.toggle('hidden');
        }
        
        async function askSocrates(msg) {
            const chat = document.getElementById('chatMessages');
            if (document.getElementById('chatSidebar').classList.contains('hidden')) return;
            
            try {
                const res = await fetch('/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message: `[Î∂ÑÎ•ò] ${msg}`})
                });
                const data = await res.json();
                chat.innerHTML += `<div class="message assistant">${data.response}</div>`;
                chat.scrollTop = chat.scrollHeight;
            } catch (e) {}
        }
        
        async function sendChat() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;
            input.value = '';
            
            const chat = document.getElementById('chatMessages');
            chat.innerHTML += `<div class="message user">${msg}</div>`;
            
            try {
                const res = await fetch('/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message: msg})
                });
                const data = await res.json();
                chat.innerHTML += `<div class="message assistant">${data.response}</div>`;
                chat.scrollTop = chat.scrollHeight;
            } catch (e) {
                chat.innerHTML += `<div class="message assistant">Ïò§Î•ò Î∞úÏÉù</div>`;
            }
        }
        
        // ÏÉÅÌÉú Ï†ÄÏû•
        async function saveState() {
            const columns = [];
            const cards = {};
            
            document.querySelectorAll('.column').forEach(col => {
                const id = col.id;
                const name = col.querySelector('input')?.value || '';
                const cardList = [];
                col.querySelectorAll('.card').forEach(card => {
                    cardList.push({id: card.id, text: card.textContent});
                });
                columns.push({id, name});
                cards[id] = cardList;
            });
            
            await fetch('/save_kanban', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({columns, cards})
            });
        }
        
        // ÏÉÅÌÉú Î∂àÎü¨Ïò§Í∏∞
        async function loadState() {
            try {
                const res = await fetch('/load_kanban');
                const data = await res.json();
                
                if (data.columns && data.columns.length > 0) {
                    // Ï†ÄÏû•Îêú ÏÉÅÌÉúÍ∞Ä ÏûàÏúºÎ©¥ Î≥µÏõê
                    // Í∏∞Ï°¥ Ïó¥ Ï†úÍ±∞ (ÎØ∏Î∂ÑÎ•ò Ï†úÏô∏)
                    document.querySelectorAll('.column:not(.unassigned)').forEach(col => col.remove());
                    
                    // Ïó¥ Î≥µÏõê
                    data.columns.forEach(col => {
                        if (col.id === 'unassigned') {
                            // ÎØ∏Î∂ÑÎ•ò Ïπ¥Îìú Î≥µÏõê
                            const body = document.querySelector('#unassigned .column-body');
                            body.innerHTML = '';
                            (data.cards[col.id] || []).forEach(c => {
                                body.appendChild(createCard(c.text, c.id));
                            });
                        } else {
                            const column = document.createElement('div');
                            column.className = 'column';
                            column.id = col.id;
                            column.innerHTML = `
                                <div class="column-header">
                                    <input type="text" value="${col.name}" placeholder="Ïó¥ Ïù¥Î¶Ñ..." onchange="saveState()">
                                    <span class="column-count">0</span>
                                </div>
                                <div class="column-body" data-column="${col.id}"></div>
                                <div class="column-footer">
                                    <button class="add-card-btn" onclick="addCard('${col.id}')">+ Ìï≠Î™© Ï∂îÍ∞Ä</button>
                                </div>
                            `;
                            document.querySelector('.add-column').before(column);
                            
                            const body = column.querySelector('.column-body');
                            (data.cards[col.id] || []).forEach(c => {
                                body.appendChild(createCard(c.text, c.id));
                            });
                        }
                    });
                    
                    setupDragDrop();
                    updateCounts();
                    return true;
                }
            } catch (e) {}
            return false;
        }
        
        // ÏÉà ÏïÑÏù¥ÌÖú Î°úÎìú (STEP 1ÏóêÏÑú ÎÑòÏñ¥Ïò¨ Îïå)
        async function loadNewItems() {
            try {
                const res = await fetch('/get_items');
                const data = await res.json();
                const items = data.items || [];
                
                if (items.length > 0) {
                    const body = document.querySelector('#unassigned .column-body');
                    items.forEach(item => {
                        body.appendChild(createCard(item));
                    });
                    updateCounts();
                    saveState();
                }
            } catch (e) {}
        }
        
        async function goBackToStep1() {
            await saveState();
            window.location.href = '/?fromKanban=true';
        }
        
        async function saveAndContinue() {
            await saveState();
            
            const classification = {};
            document.querySelectorAll('.column').forEach(col => {
                const name = col.querySelector('input')?.value || col.id;
                const cards = Array.from(col.querySelectorAll('.card')).map(c => c.textContent);
                if (cards.length > 0) {
                    classification[name] = cards;
                }
            });
            
            await fetch('/save_classification', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({classification})
            });
            
            window.location.href = '/?step=3';
        }
        
        // Ï¥àÍ∏∞Ìôî
        async function init() {
            setupDragDrop();
            
            const hasState = await loadState();
            if (!hasState) {
                await loadNewItems();
            }
            
            // Ïù∏ÏÇ¨
            document.getElementById('chatMessages').innerHTML = `
                <div class="message assistant">
                    STEP 2Ïïº! Ìè¨Ïä§Ìä∏ÏûáÏùÑ ÎìúÎûòÍ∑∏Ìï¥ÏÑú Î∂ÑÎ•òÌï¥Î¥ê. Ïó¥ Ïù¥Î¶ÑÏùÄ ÏßÅÏ†ë ÏûÖÎ†•ÌïòÎ©¥ Îèº. ü§î
                </div>
            `;
        }
        
        init();
    </script>
</body>
</html>
