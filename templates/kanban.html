<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STEP 2: ë¶„ë¥˜ - ì¹¸ë°˜ ë³´ë“œ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            min-height: 100vh;
            padding: 20px;
        }
        
        .header {
            background: #222;
            color: white;
            padding: 14px 20px;
            border-radius: 12px;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .header h1 { font-size: 1.1rem; font-weight: 500; }
        
        .header-buttons { display: flex; gap: 8px; }
        
        .header button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.85rem;
        }
        
        .header button:hover { background: rgba(255,255,255,0.3); }
        .header button.primary { background: #555; }
        
        .main-container {
            display: flex;
            gap: 16px;
            height: calc(100vh - 100px);
        }
        
        .board-container {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            flex: 1;
            padding-bottom: 10px;
            align-items: flex-start;
        }
        
        .column {
            background: #f5f5f5;
            border-radius: 10px;
            min-width: 300px;
            max-width: 300px;
            display: flex;
            flex-direction: column;
            max-height: 100%;
        }
        
        .column-header {
            padding: 10px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
        }
        
        .column-header input {
            background: transparent;
            border: none;
            font-size: 0.9rem;
            font-weight: 600;
            color: #333;
            width: 80%;
        }
        
        .column-header input:focus { 
            outline: none; 
            background: white; 
            border-radius: 4px; 
            padding: 4px 6px;
            margin: -4px -6px;
        }
        
        .column-header input::placeholder { color: #999; }
        
        .column-delete {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1rem;
            padding: 2px 6px;
            margin-left: 4px;
        }
        .column-delete:hover { color: #666; }
        
        .column-count {
            background: #333;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            min-width: 20px;
            text-align: center;
        }
        
        .column-body {
            padding: 8px;
            flex: 1;
            overflow-y: auto;
            min-height: 80px;
        }
        
        .column-body.drag-over { background: #ddd; }
        
        .column-footer {
            padding: 8px;
            border-top: 1px solid #eee;
        }
        
        .add-card-btn {
            width: 100%;
            padding: 6px;
            background: transparent;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 0.8rem;
            text-align: left;
        }
        
        .add-card-btn:hover { color: #333; }
        
        .card {
            background: white;
            border-radius: 6px;
            padding: 8px 10px;
            margin-bottom: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            cursor: grab;
            font-size: 0.85rem;
            line-height: 1.4;
            word-break: keep-all;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 6px;
        }
        
        .card.dragging {
            opacity: 0.5;
        }
        
        /* ë“œë˜ê·¸ ì¤‘ì¼ ë•Œ ë‹¤ë¥¸ ì¹´ë“œë“¤ì´ ë“œë¡­ì„ ë°©í•´í•˜ì§€ ì•Šë„ë¡ */
        .column-body.drag-over .card {
            pointer-events: none;
        }
        
        .card-text { flex: 1; }
        
        .card-delete {
            background: none;
            border: none;
            color: #ccc;
            cursor: pointer;
            font-size: 0.85rem;
            padding: 0 2px;
            line-height: 1;
            flex-shrink: 0;
        }
        
        .card-delete:hover { color: #666; }
        
        .card:hover { box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
        .card.dragging { opacity: 0.5; }
        
        .add-column {
            background: rgba(255,255,255,0.08);
            border: 2px dashed rgba(255,255,255,0.25);
            border-radius: 10px;
            min-width: 240px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            color: rgba(255,255,255,0.5);
            font-size: 0.9rem;
            padding: 30px 20px;
            transition: all 0.2s;
        }
        
        .add-column:hover {
            background: rgba(255,255,255,0.15);
            color: white;
            border-color: rgba(255,255,255,0.4);
        }
        
        .unassigned { background: #eee; }
        .unassigned .column-header { background: #ddd; }
        
        /* ì±„íŒ… ì‚¬ì´ë“œë°” */
        .chat-sidebar {
            width: 320px;
            min-width: 320px;
            background: white;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        
        .chat-sidebar.hidden {
            width: 0;
            min-width: 0;
            opacity: 0;
            overflow: hidden;
        }
        
        .chat-header {
            padding: 12px 14px;
            background: #333;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 10px 10px 0 0;
        }
        
        .chat-header h3 { font-size: 0.95rem; }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            font-size: 0.85rem;
        }
        
        .chat-input {
            padding: 10px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 6px;
        }
        
        .chat-input input {
            flex: 1;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.85rem;
        }
        
        .chat-input button {
            padding: 8px 12px;
            background: #333;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .message {
            margin-bottom: 8px;
            padding: 8px 10px;
            border-radius: 8px;
            max-width: 90%;
            line-height: 1.4;
        }
        
        .message.user {
            background: #333;
            color: white;
            margin-left: auto;
        }
        
        .message.assistant {
            background: white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .chat-toggle-btn {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 50px;
            height: 50px;
            background: #333;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: none;
        }
        
        .chat-sidebar.hidden + .chat-toggle-btn { display: flex; justify-content: center; align-items: center; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ”€ STEP 2: ë¶„ë¥˜ <span id="projectName" style="font-size:0.8rem;opacity:0.7;"></span></h1>
        <div class="header-buttons">
            <button onclick="goBackToStep1()">â† STEP 1</button>
            <button onclick="toggleChat()">ğŸ’¬</button>
            <button id="reviewBtn" onclick="reviewClassification()" style="background:#444;">ğŸ” ë¶„ë¥˜ ê²€í† </button>
            <button onclick="saveAndContinue()" class="primary">ì €ì¥ & STEP 3 â†’</button>
            <button onclick="location.href='/logout'" style="background:#666;margin-left:8px;">ğŸšª</button>
        </div>
    </div>
    
    <div class="main-container">
        <div class="board-container" id="boardContainer">
            <!-- ë¯¸ë¶„ë¥˜ ì—´ -->
            <div class="column unassigned" id="unassigned">
                <div class="column-header">
                    <span style="font-weight:600;">ğŸ“‹ ë¯¸ë¶„ë¥˜</span>
                    <span class="column-count">0</span>
                </div>
                <div class="column-body" data-column="unassigned"></div>
                <div class="column-footer">
                    <button class="add-card-btn" onclick="addCard('unassigned')">+ í•­ëª© ì¶”ê°€</button>
                </div>
            </div>
            
            <!-- ë¹ˆ ì—´ 3ê°œ -->
            <div class="column" id="col-1">
                <div class="column-header">
                    <input type="text" placeholder="ì—´ ì´ë¦„..." onchange="saveState()">
                    <span class="column-count">0</span>
                    <button class="column-delete" onclick="deleteColumn('col-1')" title="ì—´ ì‚­ì œ">âœ•</button>
                </div>
                <div class="column-body" data-column="col-1"></div>
                <div class="column-footer">
                    <button class="add-card-btn" onclick="addCard('col-1')">+ í•­ëª© ì¶”ê°€</button>
                </div>
            </div>
            
            <div class="column" id="col-2">
                <div class="column-header">
                    <input type="text" placeholder="ì—´ ì´ë¦„..." onchange="saveState()">
                    <span class="column-count">0</span>
                    <button class="column-delete" onclick="deleteColumn('col-2')" title="ì—´ ì‚­ì œ">âœ•</button>
                </div>
                <div class="column-body" data-column="col-2"></div>
                <div class="column-footer">
                    <button class="add-card-btn" onclick="addCard('col-2')">+ í•­ëª© ì¶”ê°€</button>
                </div>
            </div>
            
            <div class="column" id="col-3">
                <div class="column-header">
                    <input type="text" placeholder="ì—´ ì´ë¦„..." onchange="saveState()">
                    <span class="column-count">0</span>
                    <button class="column-delete" onclick="deleteColumn('col-3')" title="ì—´ ì‚­ì œ">âœ•</button>
                </div>
                <div class="column-body" data-column="col-3"></div>
                <div class="column-footer">
                    <button class="add-card-btn" onclick="addCard('col-3')">+ í•­ëª© ì¶”ê°€</button>
                </div>
            </div>
            
            <!-- ì—´ ì¶”ê°€ ë²„íŠ¼ -->
            <div class="add-column" onclick="addColumn()">+ ì—´ ì¶”ê°€</div>
        </div>
        
        <!-- ì±„íŒ… ì‚¬ì´ë“œë°” -->
        <div class="chat-sidebar" id="chatSidebar">
            <div class="chat-header">
                <h3>ğŸ›ï¸ ì†Œí¬ë¼í…ŒìŠ¤</h3>
                <button onclick="toggleChat()" style="background:none;border:none;color:white;font-size:16px;cursor:pointer;">âœ•</button>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input">
                <input type="text" id="chatInput" placeholder="ì§ˆë¬¸..." onkeydown="if(event.key==='Enter')sendChat()">
                <button onclick="sendChat()">ì „ì†¡</button>
            </div>
        </div>
        <button class="chat-toggle-btn" onclick="toggleChat()">ğŸ’¬</button>
    </div>
    
    <script>
        let cardIdCounter = 0;
        let columnIdCounter = 4;
        
        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì •
        function setupDragDrop() {
            // ì—´ ì „ì²´ì— ì´ë²¤íŠ¸ ì„¤ì • (í—¤ë”, ì¹´ë“œ ìœ„ì— ë“œë¡­í•´ë„ ì¸ì‹)
            document.querySelectorAll('.column').forEach(col => {
                col.ondragover = (e) => { e.preventDefault(); };
                col.ondragenter = (e) => { 
                    const body = col.querySelector('.column-body');
                    if (body) body.classList.add('drag-over'); 
                };
                col.ondragleave = (e) => { 
                    // ì—´ ë°–ìœ¼ë¡œ ë‚˜ê°ˆ ë•Œë§Œ í•˜ì´ë¼ì´íŠ¸ ì œê±°
                    if (!col.contains(e.relatedTarget)) {
                        const body = col.querySelector('.column-body');
                        if (body) body.classList.remove('drag-over'); 
                    }
                };
                col.ondrop = drop;
            });
        }
        
        function createCard(text, id = null) {
            const card = document.createElement('div');
            card.className = 'card';
            card.draggable = true;
            card.id = id || `card-${cardIdCounter++}`;
            
            const textSpan = document.createElement('span');
            textSpan.className = 'card-text';
            textSpan.textContent = text;
            card.appendChild(textSpan);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'card-delete';
            deleteBtn.textContent = 'âœ•';
            deleteBtn.title = 'ì‚­ì œ';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                card.remove();
                updateCounts();
                saveState();
            };
            card.appendChild(deleteBtn);
            
            card.ondragstart = (e) => {
                card.classList.add('dragging');
                e.dataTransfer.setData('text/plain', card.id);
            };
            card.ondragend = (e) => card.classList.remove('dragging');
            return card;
        }
        
        function drop(e) {
            e.preventDefault();
            let target = e.target;
            
            // ì—´ ì–´ë””ì— ë“œë¡­í•´ë„ ì¸ì‹ë˜ë„ë¡
            if (!target.classList.contains('column-body')) {
                // ì—´ ë‚´ë¶€ì˜ ì•„ë¬´ ê³³ì´ë‚˜ ë“œë¡­í•´ë„ column-body ì°¾ê¸°
                const column = target.closest('.column');
                if (column) {
                    target = column.querySelector('.column-body');
                }
            }
            
            if (target && target.classList.contains('column-body')) {
                target.classList.remove('drag-over');
                const cardId = e.dataTransfer.getData('text/plain');
                const card = document.getElementById(cardId);
                if (card) {
                    target.appendChild(card);
                    updateCounts();
                    saveState();
                }
            }
        }
        
        function addCard(columnId) {
            const text = prompt('ìƒˆ í•­ëª©:');
            if (!text) return;
            
            const col = document.getElementById(columnId);
            const body = col.querySelector('.column-body');
            body.appendChild(createCard(text));
            updateCounts();
            saveState();
        }
        
        function addColumn() {
            const colId = `col-${columnIdCounter++}`;
            const column = document.createElement('div');
            column.className = 'column';
            column.id = colId;
            column.innerHTML = `
                <div class="column-header">
                    <input type="text" placeholder="ì—´ ì´ë¦„..." onchange="saveState()">
                    <span class="column-count">0</span>
                    <button class="column-delete" onclick="deleteColumn('${colId}')" title="ì—´ ì‚­ì œ">âœ•</button>
                </div>
                <div class="column-body" data-column="${colId}"></div>
                <div class="column-footer">
                    <button class="add-card-btn" onclick="addCard('${colId}')">+ í•­ëª© ì¶”ê°€</button>
                </div>
            `;
            
            document.querySelector('.add-column').before(column);
            setupDragDrop();
            saveState();
        }
        
        function deleteColumn(colId) {
            const col = document.getElementById(colId);
            if (!col) return;
            
            const cards = col.querySelectorAll('.card');
            if (cards.length > 0) {
                if (!confirm(`ì´ ì—´ì— ${cards.length}ê°œì˜ ì¹´ë“œê°€ ìˆìŠµë‹ˆë‹¤. ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    return;
                }
            }
            col.remove();
            saveState();
        }
        
        function updateCounts() {
            document.querySelectorAll('.column').forEach(col => {
                const count = col.querySelector('.column-body').children.length;
                col.querySelector('.column-count').textContent = count;
            });
        }
        
        function toggleChat() {
            document.getElementById('chatSidebar').classList.toggle('hidden');
        }
        
        async function askSocrates(msg) {
            const chat = document.getElementById('chatMessages');
            console.log('askSocrates í˜¸ì¶œ, ë©”ì‹œì§€:', msg.substring(0, 100) + '...');
            
            try {
                const res = await fetch('/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message: `[ë¶„ë¥˜] ${msg}`})
                });
                console.log('API ì‘ë‹µ ë°›ìŒ:', res.status);
                const data = await res.json();
                console.log('ì‘ë‹µ ë°ì´í„°:', data);
                chat.innerHTML += `<div class="message assistant">${parseMarkdown(data.response)}</div>`;
                chat.scrollTop = chat.scrollHeight;
            } catch (e) {
                console.error('askSocrates ì—ëŸ¬:', e);
                chat.innerHTML += `<div class="message assistant">ì˜¤ë¥˜: ${e.message}</div>`;
            }
        }
        
        // ê°„ë‹¨í•œ ë§ˆí¬ë‹¤ìš´ íŒŒì‹±
        function parseMarkdown(text) {
            return text
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')  // **bold**
                .replace(/\*(.+?)\*/g, '<em>$1</em>')              // *italic*
                .replace(/\n/g, '<br>');                           // ì¤„ë°”ê¿ˆ
        }
        
        async function reviewClassification() {
            console.log('reviewClassification í˜¸ì¶œë¨!');
            
            // ë²„íŠ¼ ë¡œë”© ìƒíƒœ
            const btn = document.getElementById('reviewBtn');
            const originalText = btn.textContent;
            btn.textContent = 'â³ ê²€í†  ì¤‘...';
            btn.disabled = true;
            btn.style.opacity = '0.6';
            
            // ì±„íŒ…ì°½ ì—´ê¸°
            document.getElementById('chatSidebar').classList.remove('hidden');
            
            // ë¡œë”© í‘œì‹œ
            const chat = document.getElementById('chatMessages');
            console.log('chat element:', chat);
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message assistant';
            loadingDiv.id = 'loadingMsg';
            loadingDiv.textContent = 'ğŸ”„ ë¶„ë¥˜ ê²€í†  ì¤‘...';
            chat.appendChild(loadingDiv);
            chat.scrollTop = chat.scrollHeight;
            console.log('ë¡œë”© ë©”ì‹œì§€ ì¶”ê°€ë¨');
            
            // DOM ì—…ë°ì´íŠ¸ê°€ ë Œë”ë§ë  ì‹œê°„ ì£¼ê¸°
            await new Promise(r => setTimeout(r, 50));
            
            // í˜„ì¬ ë¶„ë¥˜ ìƒíƒœ ìˆ˜ì§‘
            const columns = [];
            let colIndex = 1;
            
            document.querySelectorAll('.column').forEach(col => {
                const input = col.querySelector('input');
                let name;
                if (col.id === 'unassigned') {
                    name = 'ë¯¸ë¶„ë¥˜';
                } else {
                    name = input?.value?.trim() || `ê·¸ë£¹${colIndex++}`;
                }
                
                // column-body ì•ˆì˜ ì¹´ë“œë“¤ ì°¾ê¸°
                const body = col.querySelector('.column-body');
                const cardElements = body ? body.querySelectorAll('.card') : [];
                const cards = Array.from(cardElements)
                    .map(c => {
                        const textEl = c.querySelector('.card-text');
                        return textEl ? textEl.textContent.trim() : c.textContent.replace('âœ•', '').trim();
                    })
                    .filter(t => t.length > 0);
                
                console.log(`Column "${name}": ${cards.length} cards`, cards);
                
                if (cards.length > 0) {
                    columns.push({ name, cards, isUnassigned: col.id === 'unassigned' });
                }
            });
            
            console.log('Total columns with cards:', columns);
            
            // ë¶„ë¥˜ ìš”ì•½ ë©”ì‹œì§€ ìƒì„±
            let summary = 'í˜„ì¬ ë¶„ë¥˜ ìƒíƒœ:\n';
            
            columns.forEach(col => {
                if (!col.isUnassigned) {
                    summary += `\n**[${col.name}]**: ${col.cards.join(', ')}`;
                }
            });
            
            const unassigned = columns.find(c => c.isUnassigned);
            if (unassigned && unassigned.cards.length > 0) {
                summary += `\n\n**[ë¯¸ë¶„ë¥˜]** (${unassigned.cards.length}ê°œ): ${unassigned.cards.join(', ')}`;
            }
            
            summary += '\n\n[STEP 2 ë¶„ë¥˜ ê²€í†  ìš”ì²­]\në¶„ë¥˜ì— ëŒ€í•´ì„œë§Œ ì§ˆë¬¸í•´ì¤˜. í•œ ë²ˆì— ì§ˆë¬¸ 1ê°œë§Œ!\nì˜ˆì‹œ: "ì™œ ì´ê±¸ ì´ ê·¸ë£¹ì— ë„£ì—ˆì–´?", "ì´ ê·¸ë£¹ì˜ ê¸°ì¤€ì´ ë­ì•¼?", "ë¹ ì§„ í•­ëª© ì—†ì–´?"';
            
            console.log('Summary to send:', summary);
            
            // ë¡œë”© ë©”ì‹œì§€ ì œê±° í›„ ì‘ë‹µ í‘œì‹œ
            document.getElementById('loadingMsg')?.remove();
            await askSocrates(summary);
            
            // ë²„íŠ¼ ì›ë˜ëŒ€ë¡œ
            btn.textContent = originalText;
            btn.disabled = false;
            btn.style.opacity = '1';
        }
        
        async function sendChat() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;
            input.value = '';
            
            const chat = document.getElementById('chatMessages');
            chat.innerHTML += `<div class="message user">${msg}</div>`;
            
            try {
                const res = await fetch('/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({message: msg})
                });
                const data = await res.json();
                chat.innerHTML += `<div class="message assistant">${parseMarkdown(data.response)}</div>`;
                chat.scrollTop = chat.scrollHeight;
            } catch (e) {
                chat.innerHTML += `<div class="message assistant">ì˜¤ë¥˜ ë°œìƒ</div>`;
            }
        }
        
        // ìƒíƒœ ì €ì¥
        async function saveState() {
            const columns = [];
            const cards = {};
            
            document.querySelectorAll('.column').forEach(col => {
                const id = col.id;
                const name = col.querySelector('input')?.value || '';
                const cardList = [];
                col.querySelectorAll('.card').forEach(card => {
                    cardList.push({id: card.id, text: card.querySelector('.card-text')?.textContent || card.textContent});
                });
                columns.push({id, name});
                cards[id] = cardList;
            });
            
            await fetch('/save_kanban', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({columns, cards})
            });
        }
        
        // ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadState() {
            try {
                const res = await fetch('/load_kanban');
                const data = await res.json();
                
                if (data.columns && data.columns.length > 0) {
                    // ì €ì¥ëœ ìƒíƒœê°€ ìˆìœ¼ë©´ ë³µì›
                    // ê¸°ì¡´ ì—´ ì œê±° (ë¯¸ë¶„ë¥˜ ì œì™¸)
                    document.querySelectorAll('.column:not(.unassigned)').forEach(col => col.remove());
                    
                    // ì—´ ë³µì›
                    data.columns.forEach(col => {
                        if (col.id === 'unassigned') {
                            // ë¯¸ë¶„ë¥˜ ì¹´ë“œ ë³µì›
                            const body = document.querySelector('#unassigned .column-body');
                            body.innerHTML = '';
                            (data.cards[col.id] || []).forEach(c => {
                                body.appendChild(createCard(c.text, c.id));
                            });
                        } else {
                            const column = document.createElement('div');
                            column.className = 'column';
                            column.id = col.id;
                            column.innerHTML = `
                                <div class="column-header">
                                    <input type="text" value="${col.name}" placeholder="ì—´ ì´ë¦„..." onchange="saveState()">
                                    <span class="column-count">0</span>
                                </div>
                                <div class="column-body" data-column="${col.id}"></div>
                                <div class="column-footer">
                                    <button class="add-card-btn" onclick="addCard('${col.id}')">+ í•­ëª© ì¶”ê°€</button>
                                </div>
                            `;
                            document.querySelector('.add-column').before(column);
                            
                            const body = column.querySelector('.column-body');
                            (data.cards[col.id] || []).forEach(c => {
                                body.appendChild(createCard(c.text, c.id));
                            });
                        }
                    });
                    
                    setupDragDrop();
                    updateCounts();
                    return true;
                }
            } catch (e) {}
            return false;
        }
        
        // ìƒˆ ì•„ì´í…œ ë¡œë“œ (STEP 1ì—ì„œ ë„˜ì–´ì˜¬ ë•Œ)
        async function loadNewItems() {
            try {
                let res = await fetch('/get_items');
                let data = await res.json();
                let items = data.items || [];
                
                // ì•„ì´í…œì´ ì—†ìœ¼ë©´ ëŒ€í™”ì—ì„œ ì¶”ì¶œ ì‹œë„
                if (items.length === 0) {
                    const extractRes = await fetch('/extract_items', { method: 'POST' });
                    const extractData = await extractRes.json();
                    items = extractData.items || [];
                }
                
                if (items.length > 0) {
                    const body = document.querySelector('#unassigned .column-body');
                    items.forEach(item => {
                        body.appendChild(createCard(item));
                    });
                    updateCounts();
                    saveState();
                }
            } catch (e) {
                console.error('Error loading items:', e);
            }
        }
        
        async function goBackToStep1() {
            await saveState();
            window.location.href = '/?fromKanban=true';
        }
        
        async function saveAndContinue() {
            await saveState();
            
            const classification = {};
            document.querySelectorAll('.column').forEach(col => {
                const name = col.querySelector('input')?.value || col.id;
                const cards = Array.from(col.querySelectorAll('.card')).map(c => c.querySelector('.card-text')?.textContent || c.textContent);
                if (cards.length > 0) {
                    classification[name] = cards;
                }
            });
            
            await fetch('/save_classification', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({classification})
            });
            
            window.location.href = '/?step=3';
        }
        
        // ì´ˆê¸°í™”
        async function init() {
            setupDragDrop();
            
            await loadState();
            
            // ë¯¸ë¶„ë¥˜ ì—´ì— ì¹´ë“œê°€ ì—†ìœ¼ë©´ ì•„ì´í…œ ë¡œë“œ
            const unassignedCards = document.querySelectorAll('#unassigned .card');
            if (unassignedCards.length === 0) {
                // ë‹¤ë¥¸ ì—´ì—ë„ ì¹´ë“œê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ë¡œë“œ
                const allCards = document.querySelectorAll('.card');
                if (allCards.length === 0) {
                    await loadNewItems();
                }
            }
            
            // ì¸ì‚¬
            document.getElementById('chatMessages').innerHTML = `
                <div class="message assistant">
                    STEP 2ì•¼! í¬ìŠ¤íŠ¸ì‡ì„ ë“œë˜ê·¸í•´ì„œ ë¶„ë¥˜í•´ë´. ì—´ ì´ë¦„ì€ ì§ì ‘ ì…ë ¥í•˜ë©´ ë¼. ğŸ¤”
                </div>
            `;
        }
        
        // í”„ë¡œì íŠ¸ëª… í‘œì‹œ
        fetch('/current_project').then(r=>r.json()).then(d=>{
            if(d.project) document.getElementById('projectName').textContent = 'ğŸ“ '+d.project;
        });
        
        init();
    </script>
</body>
</html>
